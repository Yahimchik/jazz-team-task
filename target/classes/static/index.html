<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>Robot World Control Panel</title>
    <style>
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –∏ —Ñ–æ–Ω */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;         /* –æ—á–µ–Ω—å —Å–≤–µ—Ç–ª—ã–π —Å–µ—Ä–æ-–≥–æ–ª—É–±–æ–π */
            color: #1e2a38;              /* –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–π —Ç–µ–º–Ω–æ-—Å–∏–Ω–∏–π, —á—É—Ç—å —Ç–µ–º–Ω–µ–µ */
            margin: 0;
            padding: 30px 20px 40px;     /* —Å–≤–µ—Ä—Ö—É 30, –ø–æ –±–æ–∫–∞–º 20, —Å–Ω–∏–∑—É 40 */
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        h2 {
            margin-bottom: 20px;
            color: #4caf50;              /* –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–π –∑–µ–ª—ë–Ω—ã–π */
            text-shadow: 0 0 6px #81c784dd; /* —á—É—Ç—å —è—Ä—á–µ —Å–≤–µ—á */
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        .container {
            width: 100%;
            max-width: 720px;
            background: #ffffff;         /* –±–µ–ª—ã–π —Ñ–æ–Ω */
            border-radius: 10px;
            padding: 25px 30px;
            box-shadow: 0 0 25px #a5d6a7ee; /* —á—É—Ç—å —è—Ä—á–µ —Ç–µ–Ω—å –∑–µ–ª—ë–Ω–æ–≥–æ */
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-sizing: border-box;
        }

        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ª–æ–≥–∞ (–≤–Ω–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞) */
        #logTitle {
            width: 100%;
            max-width: 720px;
            margin: 30px 0 10px;
            color: #4caf50;
            text-align: center;
            font-weight: 600;
            user-select: none;
        }

        /* –õ–æ–≥ - –∑–∞–Ω–∏–º–∞–µ—Ç –≤—Å—é —à–∏—Ä–∏–Ω—É —Å –æ—Ç—Å—Ç—É–ø–∞–º–∏ */
        #log {
            background: #f0f4f8;         /* —Å–≤–µ—Ç–ª—ã–π –≥–æ–ª—É–±–æ–π */
            border-radius: 10px;
            padding: 20px;
            height: 480px;               /* –±–æ–ª—å—à–∞—è –≤—ã—Å–æ—Ç–∞ */
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
            box-shadow: inset 0 0 12px #90a4ae;
            color: #263238;              /* –±–æ–ª–µ–µ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã–π —Ç—ë–º–Ω–æ-—Å–∏–Ω–∏–π */
            font-size: 0.95rem;
            line-height: 1.5;
            width: 100%;
            max-width: 1280px;
            box-sizing: border-box;
            margin: 0 auto;             /* –ø–æ —Ü–µ–Ω—Ç—Ä—É */
        }

        /* –§–æ—Ä–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        label {
            flex: 0 0 160px;
            font-weight: 600;
            color: #558b2f;             /* –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–π –∑–µ–ª—ë–Ω—ã–π, –ø—Ä–∏—è—Ç–Ω—ã–π –≥–ª–∞–∑—É */
        }

        select, input[type="text"], input[type="number"] {
            flex: 1 1 220px;
            padding: 10px 12px;
            border-radius: 6px;
            border: none;
            background: #333;
            color: #eee;
            font-size: 1rem;
            transition: background-color 0.3s ease;
        }

        select:focus, input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            background: #81c784;
            color: #121212;
            box-shadow: 0 0 10px #66bb6a;
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        button {
            cursor: pointer;
            padding: 12px 20px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.25s ease;
            flex: 1 1 180px;
            box-shadow: 0 5px 15px #4caf5077;
        }

        button:hover {
            background: #66bb6a;
            box-shadow: 0 7px 20px #66bb6aaa;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ */
        .buttons-row {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
            justify-content: flex-start;
        }

        /* –°—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏—è */
        #status {
            margin-top: 10px;
            font-weight: 600;
            color: #33691e;  /* –≥–ª—É–±–æ–∫–∏–π –∑–µ–ª—ë–Ω—ã–π */
        }

        /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 500px) {
            .form-row {
                flex-direction: column;
                align-items: stretch;
            }

            label, select, input, button {
                flex: 1 1 100%;
            }

            .buttons-row {
                flex-direction: column;
            }
        }

        .log-error {
            color: #d32f2f;
            font-weight: 700;
        }

        .log-warning {
            color: #fbc02d;
            font-weight: 600;
        }

        .log-info {
            color: #33691e;
        }

        .log-debug {
            color: #607d8b;
        }

        .log-simple-robot {
            color: #4caf50;  /* –∑–µ–ª—ë–Ω—ã–π */
            font-weight: 600;
        }
        .log-robot-manager {
            color: #2196f3;  /* —Å–∏–Ω–∏–π */
            font-weight: 600;
        }
        .log-other-class {
            color: #ff9800;  /* –æ—Ä–∞–Ω–∂–µ–≤—ã–π */
            font-weight: 600;
        }
        .log-default {
            color: #263238;  /* –±–∞–∑–æ–≤—ã–π —Ç—ë–º–Ω–æ-—Å–∏–Ω–∏–π */
        }

    </style>
</head>
<body>

<h2>üéõ Robot World Control Panel</h2>

<div class="container">
    <div class="form-row">
        <label for="robotSelect">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–±–æ—Ç–∞:</label>
        <select id="robotSelect"><option value="">–í—Å–µ —Ä–æ–±–æ—Ç—ã</option></select>
    </div>

    <div class="form-row">
        <label for="taskType">–¢–∏–ø –∑–∞–¥–∞—á–∏:</label>
        <select id="taskType">
            <option value="WORK">WORK</option>
        </select>
    </div>

    <div class="form-row">
        <label for="payload">Payload:</label>
        <input type="text" id="payload" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" autocomplete="off" />
    </div>

    <div class="form-row">
        <label for="complexity">–°–ª–æ–∂–Ω–æ—Å—Ç—å –∑–∞–¥–∞—á–∏ (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ):</label>
        <input type="number" id="complexity" value="1" min="1" />
    </div>

    <div class="buttons-row">
        <button id="sendTaskBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
        <button id="batchSendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å 20 –∑–∞–¥–∞—á</button>
    </div>

    <div id="status"></div>
</div>

<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –ª–æ–≥ –≤–Ω–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É -->
<h3 id="logTitle">–õ–æ–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–æ–±–æ—Ç–æ–≤</h3>
<div id="log"></div>

<script>
    const logDiv = document.getElementById("log");
    const robotSelect = document.getElementById("robotSelect");
    const taskTypeSelect = document.getElementById("taskType");
    const payloadInput = document.getElementById("payload");
    const complexityInput = document.getElementById("complexity");
    const sendTaskBtn = document.getElementById("sendTaskBtn");
    const batchSendBtn = document.getElementById("batchSendBtn");
    const statusDiv = document.getElementById("status");

    // –¶–≤–µ—Ç–∞ –¥–ª—è id
    const idColorMap = new Map();
    const colors = [
        '#e91e63', '#9c27b0', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4',
        '#009688', '#4caf50', '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107',
        '#ff9800', '#ff5722', '#795548', '#607d8b'
    ];

    function getColorForId(id) {
        if (!idColorMap.has(id)) {
            const color = colors[idColorMap.size % colors.length];
            idColorMap.set(id, color);
        }
        return idColorMap.get(id);
    }

    // WebSocket –¥–ª—è –ª–æ–≥–æ–≤
    const socket = new WebSocket("ws://" + window.location.host + "/ws/logs");
    socket.onmessage = event => {
        const text = event.data;

        const regex = /^(\S+)\s+\[(\w+)]\s+(\S+)\s+-\s+(\S+)\s+(.*)$/;
        const match = text.match(regex);

        if (!match) {
            // –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç, –ø—Ä–æ—Å—Ç–æ –≤—ã–≤–æ–¥–∏–º –∫–∞–∫ –µ—Å—Ç—å
            const div = document.createElement('div');
            div.textContent = text;
            div.classList.add('log-default');
            logDiv.appendChild(div);
            logDiv.scrollTop = logDiv.scrollHeight;
            return;
        }

        const [, timestamp, level, className, id, message] = match;

        const div = document.createElement('div');

        // timestamp - –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç
        div.appendChild(document.createTextNode(timestamp + ' '));

        // level - –∫—Ä–∞—Å–∏–º –ø–æ —É—Ä–æ–≤–Ω—é
        const levelSpan = document.createElement('span');
        levelSpan.textContent = '[' + level + '] ';
        switch (level.toUpperCase()) {
            case 'ERROR':
                levelSpan.style.color = '#d32f2f';
                levelSpan.style.fontWeight = '700';
                break;
            case 'WARN':
            case 'WARNING':
                levelSpan.style.color = '#fbc02d';
                levelSpan.style.fontWeight = '600';
                break;
            case 'INFO':
                levelSpan.style.color = '#33691e';
                break;
            case 'DEBUG':
                levelSpan.style.color = '#607d8b';
                break;
            default:
                levelSpan.style.color = '#263238';
                break;
        }
        div.appendChild(levelSpan);

        // className - –∫–ª–∞—Å—Å –∏–∑ css
        const classSpan = document.createElement('span');
        classSpan.textContent = className + ' ';
        switch (className) {
            case 'SimpleRobot':
                classSpan.classList.add('log-simple-robot');
                break;
            case 'RobotManager':
                classSpan.classList.add('log-robot-manager');
                break;
            case 'OtherClassName':
                classSpan.classList.add('log-other-class');
                break;
            default:
                classSpan.classList.add('log-default');
                break;
        }
        div.appendChild(classSpan);

        // id ‚Äî —Ü–≤–µ—Ç –∏–∑ –º–∞–ø—ã
        const idSpan = document.createElement('span');
        idSpan.textContent = id + ' ';
        idSpan.style.color = getColorForId(id);
        idSpan.style.fontWeight = '700';
        div.appendChild(idSpan);

        // —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç
        const messageSpan = document.createElement('span');
        messageSpan.textContent = message;
        div.appendChild(messageSpan);

        logDiv.appendChild(div);
        logDiv.scrollTop = logDiv.scrollHeight;
    };


    socket.onopen = () => {
        statusDiv.textContent = "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É –ª–æ–≥–æ–≤";
        statusDiv.style.color = "#33691e";
    };
    socket.onerror = () => {
        statusDiv.textContent = "–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º –ª–æ–≥–æ–≤";
        statusDiv.style.color = "#d32f2f";
    };
    socket.onclose = () => {
        statusDiv.textContent = "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º –ª–æ–≥–æ–≤ –∑–∞–∫—Ä—ã—Ç–æ";
        statusDiv.style.color = "#fbc02d";
    };

    const robotSocket = new WebSocket("ws://" + window.location.host + "/ws/robots");
    robotSocket.onmessage = event => {
        const robots = event.data.split(",");
        robotSelect.innerHTML = '<option value="">–í—Å–µ —Ä–æ–±–æ—Ç—ã</option>';
        robots.forEach(id => {
            const option = document.createElement("option");
            option.value = id;
            option.textContent = id;
            robotSelect.appendChild(option);
        });
    };

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ä–æ–±–æ—Ç–æ–≤
    async function loadRobots() {
        try {
            const res = await fetch('/api/robots');
            if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
            const robots = await res.json();
            robotSelect.innerHTML = '<option value="">–í—Å–µ —Ä–æ–±–æ—Ç—ã</option>';
            robots.forEach(r => {
                const option = document.createElement("option");
                option.value = r;
                option.textContent = r;
                robotSelect.appendChild(option);
            });
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–æ–±–æ—Ç–æ–≤', e);
        }
    }

    loadRobots();
    setInterval(loadRobots, 60000);

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–¥–Ω–æ–π –∑–∞–¥–∞—á–∏
    sendTaskBtn.onclick = async () => {
        const task = {
            type: taskTypeSelect.value,
            payload: payloadInput.value.trim(),
            targetRobotId: robotSelect.value || null,
            complexity: parseInt(complexityInput.value, 10) || 1
        };
        try {
            const res = await fetch('/api/task', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(task)
            });
            if (res.ok) {
                statusDiv.textContent = "–ó–∞–¥–∞—á–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!";
                statusDiv.style.color = "#33691e";
                payloadInput.value = "";
            } else {
                statusDiv.textContent = "–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–¥–∞—á–∏";
                statusDiv.style.color = "#d32f2f";
            }
        } catch (e) {
            statusDiv.textContent = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏";
            statusDiv.style.color = "#d32f2f";
        }
    };

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–∞—á–∫–∏ –∏–∑ 20 –∑–∞–¥–∞—á
    batchSendBtn.onclick = async () => {
        const type = taskTypeSelect.value;
        const payloadBase = payloadInput.value.trim();
        const targetRobotId = robotSelect.value || null;
        const complexity = parseInt(complexityInput.value, 10) || 1;
        const count = 20;

        statusDiv.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞ –ø–∞—á–∫–∏ –∑–∞–¥–∞—á...";
        statusDiv.style.color = "#fbc02d";

        for (let i = 1; i <= count; i++) {
            const task = {
                type: type,
                payload: `${payloadBase} #${i}`,
                targetRobotId: targetRobotId,
                complexity: complexity
            };
            try {
                await fetch('/api/task', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(task)
                });
            } catch (e) {
                console.error(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–¥–∞—á–∏ #${i}`, e);
            }
        }
        statusDiv.textContent = `–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${count} –∑–∞–¥–∞—á`;
        statusDiv.style.color = "#33691e";
    };
</script>

</body>
</html>
